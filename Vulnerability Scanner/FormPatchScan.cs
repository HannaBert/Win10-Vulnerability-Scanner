using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.Text;
using System.Windows.Forms;
using System.Linq;
using System.Threading.Tasks;
using WUApiLib;
using System.Diagnostics;

namespace Vulnerability_Scanner
{
    public partial class FormPatchScan : Form
    {
        private List<PendingUpdate> pendingUpdates = new List<PendingUpdate>();

        public FormPatchScan()
        {
            InitializeComponent();
        }

        private void btnHome_Click(object sender, EventArgs e)
        {
            FormMenu formMenu = new FormMenu();
            formMenu.Show();
            this.Hide();
        }

        private void btnPatchscan_Click(object sender, EventArgs e)
        {
            //pnlPatchList.Controls.Clear();

            base.OnLoad(e);
                UpdateSession uSession = new UpdateSession();
                IUpdateSearcher uSearcher = uSession.CreateUpdateSearcher();
                uSearcher.Online = false;

            try
            {
                ISearchResult sResult = uSearcher.Search("IsInstalled=1 and IsHidden=0");

                lblPatchAmount.Text = "Found " + sResult.Updates.Count + " Updates" + Environment.NewLine;

                Point newLocation = new Point(0, 0);

                foreach (IUpdate update in sResult.Updates)
                {
                    Label lblPatches = new Label
                    {
                        Name = "lblPatches",
                        Text = update.Title + Environment.NewLine,
                        Font = new Font("Comic Sans MS", 9),
                        AutoSize = true,
                        ForeColor = Color.White,
                        Location = newLocation
                    };

                    pnlPatchList.Controls.Add(lblPatches);

                    lblPatches.BringToFront();

                    newLocation.Offset(0, lblPatches.Height + 10);

                }
            }
            catch (Exception ex)
            {
                Label lblError = new Label
                {
                    Name = "lblError",
                    Text = "It Looks Like \r\nSomthing Went \r\nWrong!",
                    Font = new Font("Comic Sans MS", 12),
                    AutoSize = true,
                    ForeColor = Color.White
                };

                pnlDescription.Controls.Add(lblError);
                lblError.BringToFront();
                throw ex;
            }
        }

        private void btnPatchscan_MouseEnter(object sender, EventArgs e)
        {
            btnCurrUpdatesscan.BackColor = Color.Turquoise;
            Label lblCurrentDetails = new Label
            {
                Name = "lblCurrDetails",
                Text = "Click to see the \r\ncurrent updates and \r\npatches on the system",
                Font = new Font("Comic Sans MS", 12),
                AutoSize = true,
                ForeColor = Color.White
            };

            pnlDescription.Controls.Add(lblCurrentDetails);
            lblCurrentDetails.BringToFront();

        }

        private void btnPatchscan_MouseLeave(object sender, EventArgs e)
        {
            btnCurrUpdatesscan.BackColor = Color.SlateBlue;
            pnlDescription.Controls.Clear();
        }

        private void btnHome_MouseEnter(object sender, EventArgs e)
        {
            btnHome.BackColor = Color.Turquoise;
        }

        private void btnHome_MouseLeave(object sender, EventArgs e)
        {
            btnHome.BackColor = Color.SlateBlue;
        }

        private void btnRefresh_Click(object sender, EventArgs e)
        {
            
            pnlPatchList.Controls.Clear();
            
            lblPatchAmount.Text = " ";
        }

        private void btnRefresh_MouseEnter(object sender, EventArgs e)
        {
            btnRefresh.BackColor = Color.Turquoise;
        }

        private void btnRefresh_MouseLeave(object sender, EventArgs e)
        {
            btnRefresh.BackColor = Color.SlateBlue;
        }

        private void btnNeedUpdateScan_MouseEnter(object sender, EventArgs e)
        {
            
            // Mouse over, description for needed update
            btnNeedUpdateScan.BackColor = Color.Turquoise;
            Label lblCurrentDetails = new Label
            {
                Name = "lblCurrDetails",
                Text = "Click to see the \r\nneeded updates and \r\npatches for the system",
                Font = new Font("Comic Sans MS", 12),
                AutoSize = true,
                ForeColor = Color.White
            };

            pnlDescription.Controls.Add(lblCurrentDetails);
            lblCurrentDetails.BringToFront();

        }

        private void btnNeedUpdateScan_MouseLeave(object sender, EventArgs e)
        {
            btnNeedUpdateScan.BackColor = Color.SlateBlue;
            pnlDescription.Controls.Clear();
        }

        private List<PendingUpdate> GetPendingUpdates(List<PendingUpdate> pendingUpdate) 
        {
            pendingUpdate.Clear();

           
            //Add Description
            var updateSession = new UpdateSession();
            var updateSearcher = updateSession.CreateUpdateSearcher();
            updateSearcher.Online = false;
                

            //Add Description
            try
            {
                    
                //Add Description
                var searchResult = updateSearcher.Search("IsInstalled=0 And IsHidden=0");

                lblPatchAmount.Text = "Found " + searchResult.Updates.Count + " Updates" + Environment.NewLine;

                if (searchResult.Updates.Count > 0)
                {

                    foreach (IUpdate windowsUpdate in searchResult.Updates)
                    {
                        //Add Description
                        PendingUpdate update = new PendingUpdate(windowsUpdate.Title, windowsUpdate.Description, windowsUpdate.IsDownloaded, new List<string>(), " ");

                        //Add Description
                        foreach (string url in windowsUpdate.MoreInfoUrls)
                        {
                            update.Urls.Add(url);
                        }


                        //Add Description
                        pendingUpdate.Add(update);
                    }
                }
                else
                {

                    Point newLocation = new Point(0, 0);

                    Label lblNoUpdate = new Label
                    {
                        Name = "lblUpdate",
                        Text = "No Updates Where Found",
                        Font = new Font("Comic Sans MS", 9),
                        AutoSize = true,
                        ForeColor = Color.White,
                        Location = newLocation
                    };

                    pnlPatchList.Controls.Add(lblNoUpdate);

                    lblNoUpdate.BringToFront();

                }
            }
            catch (Exception ex)
            {
                Label lblError = new Label
                {
                    Name = "lblError",
                    Text = "It Looks Like \r\nSomthing Went \r\nWrong!",
                    Font = new Font("Comic Sans MS", 12),
                    AutoSize = true,
                    ForeColor = Color.White
                };

                pnlDescription.Controls.Add(lblError);
                lblError.BringToFront();
                throw ex;
            }
            
            
            return pendingUpdates;  

        }

        private void DisplayUpdate(List<PendingUpdate> pendingUpdate) 
        {
            Point newLocation = new Point(0, 0);

            foreach (var update in pendingUpdate)
            {

                Label lblUpdate = new Label
                {
                    Name = "lblUpdate",
                    Text = Text = update.Title + update.Description,
                    Font = new Font("Comic Sans MS", 9),
                    AutoSize = true,
                    ForeColor = Color.White,
                    Location = newLocation
                };

                pnlPatchList.Controls.Add(lblUpdate);

                lblUpdate.BringToFront();

                newLocation.Offset(0, lblUpdate.Height + 40);
            }
        }

        private void DisplayUpdateUrl(List<PendingUpdate> pendingUpdate)
        {
            Point newLocation2 = new Point(0, 30);

            foreach (var update in pendingUpdate)
            {
                foreach (string url in update.Urls)
                {

                    Label lblUpdateUrl = new Label
                    {
                        Name = "lblUpdateUrl",
                        Text = url,
                        Font = new Font("Comic Sans MS", 9),
                        AutoSize = true,
                        ForeColor = Color.White,
                        Location = newLocation2
                    };
                    pnlPatchList.Controls.Add(lblUpdateUrl);

                    lblUpdateUrl.BringToFront();

                    newLocation2.Offset(0, lblUpdateUrl.Height + 40);
                }
            }

        }

        private void btnNeedUpdateScan_Click(object sender, EventArgs e)
        {
            pnlPatchList.Controls.Clear();
            GetPendingUpdates(pendingUpdates);
            DisplayUpdate(pendingUpdates);
            DisplayUpdateUrl(pendingUpdates);
            

        }
    }

}
