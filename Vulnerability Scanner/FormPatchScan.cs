using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.Text;
using System.Windows.Forms;
using System.Linq;
using System.Threading.Tasks;
using WUApiLib;

namespace Vulnerability_Scanner
{
    public partial class FormPatchScan : Form
    {
        public FormPatchScan()
        {
            InitializeComponent();
        }

        private void btnHome_Click(object sender, EventArgs e)
        {
            FormMenu formMenu = new FormMenu();
            formMenu.Show();
            this.Hide();
        }

        private void btnPatchscan_Click(object sender, EventArgs e)
        {
            base.OnLoad(e);
            UpdateSession uSession = new UpdateSession();
            IUpdateSearcher uSearcher = uSession.CreateUpdateSearcher();
            uSearcher.Online = false;

            
            try {
                ISearchResult sResult = uSearcher.Search("IsInstalled=1 and IsHidden=0");

                lblPatchAmount.Text = "Found " + sResult.Updates.Count + " Updates" + Environment.NewLine;

                Point newLocation = new Point(0, 0);

                foreach (IUpdate update in sResult.Updates)
                {
                    Label lblPatches = new Label
                    {
                        Name = "lblPatches",
                        Text = update.Title + Environment.NewLine,
                        Font = new Font("Comic Sans MS", 9),
                        AutoSize = true,
                        ForeColor = Color.White,
                        Location = newLocation
                    };

                    pnlPatchList.Controls.Add(lblPatches);
                    
                    lblPatches.BringToFront();

                    newLocation.Offset(0, lblPatches.Height + 10);
                    
                    //label1.Text = update.Title + Environment.NewLine;
                }
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine("Somthing went wrong: " + ex.Message);
            }
        }

        private void btnPatchscan_MouseEnter(object sender, EventArgs e)
        {
            btnCurrUpdatesscan.BackColor = Color.Turquoise;
            Label lblCurrentDetails = new Label
            {
                Name = "lblCurrDetails",
                Text = "Click to see the \r\ncurrent updates and \r\npatches on the system",
                Font = new Font("Comic Sans MS", 12),
                AutoSize = true,
                ForeColor = Color.White
            };

            pnlDescription.Controls.Add(lblCurrentDetails);
            lblCurrentDetails.BringToFront();

        }

        private void btnPatchscan_MouseLeave(object sender, EventArgs e)
        {
            btnCurrUpdatesscan.BackColor = Color.SlateBlue;
            pnlDescription.Controls.Clear();
        }

        private void btnHome_MouseEnter(object sender, EventArgs e)
        {
            btnHome.BackColor = Color.Turquoise;
        }

        private void btnHome_MouseLeave(object sender, EventArgs e)
        {
            btnHome.BackColor = Color.SlateBlue;
        }

        private void btnRefresh_Click(object sender, EventArgs e)
        {
            pnlPatchList.Controls.Clear();
            lblPatchAmount.Text = " ";
        }

        private void btnRefresh_MouseEnter(object sender, EventArgs e)
        {
            btnRefresh.BackColor = Color.Turquoise;
        }

        private void btnRefresh_MouseLeave(object sender, EventArgs e)
        {
            btnRefresh.BackColor = Color.SlateBlue;
        }

        private void btnNeedUpdateScan_MouseEnter(object sender, EventArgs e)
        {
            btnNeedUpdateScan.BackColor = Color.Turquoise;
            Label lblCurrentDetails = new Label
            {
                Name = "lblCurrDetails",
                Text = "Click to see the \r\nneeded updates and \r\npatches for the system",
                Font = new Font("Comic Sans MS", 12),
                AutoSize = true,
                ForeColor = Color.White
            };

            pnlDescription.Controls.Add(lblCurrentDetails);
            lblCurrentDetails.BringToFront();
        }

        private void btnNeedUpdateScan_MouseLeave(object sender, EventArgs e)
        {
            btnNeedUpdateScan.BackColor = Color.SlateBlue;
            pnlDescription.Controls.Clear();
        }
    }
}
